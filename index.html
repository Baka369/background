<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dot Counter with Zoom</title>
  <script async src="https://docs.opencv.org/4.5.2/opencv.js"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      background-color: #f4f4f4;
    }
    canvas, video {
      border: 1px solid black;
      margin-top: 10px;
    }
    button, input, label {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    #result {
      font-size: 20px;
      margin-top: 10px;
    }
    #controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Dot Counter with Zoom</h1>

  <!-- Buttons and File Input -->
  <input type="file" id="imageUpload" accept="image/*" style="display:none;">
  <button id="uploadBtn">Upload Image</button>
  <button id="cameraBtn">Open Camera</button>

  <!-- Video and Canvas Elements -->
  <video id="video" autoplay playsinline style="display:none;"></video>
  <canvas id="canvas" width="640" height="480"></canvas>

  <!-- Capture and Zoom Controls -->
  <div id="controls">
    <button id="captureBtn" style="display:none;">Capture</button>
    <label for="zoomSlider">Zoom:</label>
    <input id="zoomSlider" type="range" min="1" max="3" step="0.1" value="1" style="display:none;">
  </div>

  <p id="result">Dots Counted: 0</p>

  <script>
    const uploadBtn = document.getElementById("uploadBtn");
    const cameraBtn = document.getElementById("cameraBtn");
    const imageUpload = document.getElementById("imageUpload");
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const captureBtn = document.getElementById("captureBtn");
    const zoomSlider = document.getElementById("zoomSlider");
    const ctx = canvas.getContext("2d");
    const resultText = document.getElementById("result");

    let track; // To store the video track for zoom control

    // Event: Upload Image
    uploadBtn.addEventListener("click", () => imageUpload.click());

    imageUpload.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            processImage();
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    // Event: Open Camera
    cameraBtn.addEventListener("click", () => {
      navigator.mediaDevices
        .getUserMedia({ video: { facingMode: "environment" } })
        .then((stream) => {
          video.srcObject = stream;
          video.style.display = "block";
          captureBtn.style.display = "block";
          zoomSlider.style.display = "block";
          canvas.style.display = "none";
          track = stream.getVideoTracks()[0];

          // Enable Zoom Functionality
          const capabilities = track.getCapabilities();
          if (capabilities.zoom) {
            zoomSlider.min = capabilities.zoom.min || 1;
            zoomSlider.max = capabilities.zoom.max || 3;
            zoomSlider.step = capabilities.zoom.step || 0.1;
            zoomSlider.value = capabilities.zoom.min || 1;

            zoomSlider.addEventListener("input", () => {
              track.applyConstraints({
                advanced: [{ zoom: parseFloat(zoomSlider.value) }]
              }).catch((err) => console.error("Zoom error:", err));
            });
          } else {
            console.warn("Zoom not supported on this device.");
          }
        })
        .catch((err) => console.error("Camera access error:", err));
    });

    // Event: Capture Image from Camera
    captureBtn.addEventListener("click", () => {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      processImage();
      video.style.display = "none";
      captureBtn.style.display = "none";
      zoomSlider.style.display = "none";
      canvas.style.display = "block";
    });

    // Process Image and Count Dots
    function processImage() {
      const src = cv.imread(canvas);

      // Convert to Grayscale
      const gray = new cv.Mat();
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

      // Apply Gaussian Blur to Reduce Noise
      cv.GaussianBlur(gray, gray, { width: 5, height: 5 }, 0);

      // Apply Weighted Adaptive Thresholding
      const binary = new cv.Mat();
      const blockSize = 7; // Size of pixel neighborhood
      const weightedC = 7;  // Weighted constant subtracted from mean
      cv.adaptiveThreshold(
        gray,
        binary,
        255,
        cv.ADAPTIVE_THRESH_GAUSSIAN_C,
        cv.THRESH_BINARY_INV,
        blockSize,
        weightedC
      );

      // Debug: Display Binary Image
      cv.imshow(canvas, binary);

      // Find Contours
      const contours = new cv.MatVector();
      const hierarchy = new cv.Mat();
      cv.findContours(binary, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

      // Count and Display Dots
      const dotCount = contours.size();
      console.log("Contours detected:", dotCount);
      resultText.innerText = `Dots Counted: ${dotCount}`;

      // Clean up
      src.delete();
      gray.delete();
      binary.delete();
      contours.delete();
      hierarchy.delete();
    }
  </script>
</body>
</html>
