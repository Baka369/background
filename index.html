<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dot Detector</title>
    <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
    <style>
        #canvas {
            display: block;
            margin: 20px auto;
            border: 1px solid black;
        }
        .button-container {
            text-align: center;
            margin-top: 20px;
        }
        #webcam {
            width: 100%;
            max-width: 600px;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center;">Dot Detector</h1>

    <div class="button-container">
        <button onclick="uploadImage()">Upload Image</button>
        <button onclick="startWebcam()">Start Webcam</button>
    </div>

    <div id="upload-section" style="text-align: center; display: none;">
        <input type="file" id="uploadInput" onchange="processImage()" accept="image/*" />
    </div>

    <video id="webcam" autoplay></video>
    <canvas id="canvas" width="600" height="400"></canvas>

    <script>
        let net = null;
        let videoElement = document.getElementById('webcam');
        let canvas = document.getElementById('canvas');
        let context = canvas.getContext('2d');
        let uploadInput = document.getElementById('uploadInput');

        // OpenCV.js setup
        function onOpenCvReady() {
            console.log('OpenCV.js is ready.');
        }

        // Upload image functionality
        function uploadImage() {
            document.getElementById('upload-section').style.display = 'block';
        }

        function processImage() {
            let file = uploadInput.files[0];
            let reader = new FileReader();
            reader.onload = function(e) {
                let img = new Image();
                img.onload = function() {
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    context.drawImage(img, 0, 0, canvas.width, canvas.height);
                    countDots(canvas);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Count dots in the canvas (processed image)
        function countDots(canvas) {
            let mat = cv.imread(canvas);
            cv.cvtColor(mat, mat, cv.COLOR_RGBA2GRAY, 0);

            // Threshold the image to binary
            cv.threshold(mat, mat, 100, 255, cv.THRESH_BINARY | cv.THRESH_OTSU);

            // Find contours
            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();
            cv.findContours(mat, contours, hierarchy, cv.RETR_LIST, cv.CHAIN_APPROX_SIMPLE);

            // Filter by area and count dots
            let s1 = 3, s2 = 20;
            let dotCount = 0;
            for (let i = 0; i < contours.size(); i++) {
                let cnt = contours.get(i);
                if (cv.contourArea(cnt) > s1 && cv.contourArea(cnt) < s2) {
                    dotCount++;
                }
            }

            console.log('Dots detected: ' + dotCount);
            alert('Dots detected: ' + dotCount);

            mat.delete();
            contours.delete();
            hierarchy.delete();
        }

        // Start webcam functionality
        function startWebcam() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(stream) {
                        videoElement.srcObject = stream;
                        videoElement.onloadedmetadata = function() {
                            videoElement.play();
                        };
                    })
                    .catch(function(err) {
                        console.log('Error accessing webcam: ' + err);
                    });
            } else {
                alert('Webcam not supported in your browser');
            }
        }

        // Capture image from webcam
        function captureImage() {
            context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            countDots(canvas);
        }

        // Set interval to capture image every 2 seconds
        setInterval(captureImage, 2000);
    </script>
</body>
</html>
