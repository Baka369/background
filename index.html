<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dot Detector</title>
    <script async src="https://docs.opencv.org/master/opencv.js"></script>
    <style>
        #outputCanvas {
            border: 1px solid black;
            margin-top: 10px;
        }
        #webcamCanvas {
            display: none;
        }
    </style>
</head>
<body>
    <h2>Dot Detector</h2>

    <!-- Upload Photo Section -->
    <input type="file" id="fileInput" accept="image/*">
    <button onclick="uploadImage()">Upload Image</button>

    <br><br>

    <!-- Webcam Section -->
    <button onclick="startWebcam()">Click Photo with Webcam</button>
    <video id="video" width="320" height="240" autoplay></video>
    <canvas id="webcamCanvas"></canvas>

    <br><br>

    <!-- Results -->
    <h3 id="resultText">Dots Counted: 0</h3>

    <!-- Output Canvas for Detected Dots -->
    <canvas id="outputCanvas" width="320" height="240"></canvas>

    <script>
        // Wait until OpenCV.js is loaded
        cv.onRuntimeInitialized = () => {
            console.log("OpenCV.js is ready.");
        };

        // Global variables
        let imgElement = null;
        let webcamVideo = document.getElementById("video");
        let webcamCanvas = document.getElementById("webcamCanvas");
        let outputCanvas = document.getElementById("outputCanvas");
        let resultText = document.getElementById("resultText");

        // Function to upload an image
        function uploadImage() {
            let input = document.getElementById("fileInput");
            let file = input.files[0];

            if (file) {
                let reader = new FileReader();
                reader.onload = function (e) {
                    let img = new Image();
                    img.onload = function () {
                        // Draw the image to the canvas
                        let canvas = outputCanvas;
                        let ctx = canvas.getContext("2d");
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        processImage(canvas);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // Function to start the webcam and capture photo
        function startWebcam() {
            // Get user media (webcam)
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function (stream) {
                    webcamVideo.srcObject = stream;
                    webcamVideo.play();
                }).catch(function (error) {
                    console.error("Error accessing webcam: ", error);
                });

            // Capture image from webcam
            setTimeout(function () {
                let ctx = webcamCanvas.getContext("2d");
                ctx.drawImage(webcamVideo, 0, 0, webcamCanvas.width, webcamCanvas.height);
                processImage(webcamCanvas);
            }, 1000); // Capture after 1 second
        }

        // Function to process the image and count dots
        function processImage(canvas) {
            let src = cv.imread(canvas);
            let gray = new cv.Mat();
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

            // Thresholding
            let threshed = new cv.Mat();
            cv.threshold(gray, threshed, 100, 255, cv.THRESH_BINARY | cv.THRESH_OTSU);

            // Find contours
            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();
            cv.findContours(threshed, contours, hierarchy, cv.RETR_LIST, cv.CHAIN_APPROX_SIMPLE);

            // Filter contours by area
            let s1 = 3, s2 = 20;
            let xcnts = [];
            for (let i = 0; i < contours.size(); i++) {
                let cnt = contours.get(i);
                let area = cv.contourArea(cnt);
                if (area > s1 && area < s2) {
                    xcnts.push(cnt);
                }
            }

            // Update the result text
            resultText.innerText = `Dots Counted: ${xcnts.length}`;

            // Draw contours on the output canvas
            let ctx = outputCanvas.getContext("2d");
            ctx.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
            ctx.drawImage(canvas, 0, 0, outputCanvas.width, outputCanvas.height);
            cv.drawContours(src, contours, -1, new cv.Scalar(0, 255, 0), 2);
            cv.imshow(outputCanvas, src);

            // Cleanup
            src.delete();
            gray.delete();
            threshed.delete();
            contours.delete();
            hierarchy.delete();
        }
    </script>
</body>
</html>
