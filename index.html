<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dot Counter with Shadow Removal</title>
  <script async src="https://docs.opencv.org/4.5.2/opencv.js"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      background-color: #f4f4f4;
    }
    canvas, video {
      border: 1px solid black;
      margin-top: 10px;
    }
    button, input {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    #result {
      font-size: 20px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Dot Counter with Shadow Removal</h1>

  <!-- Buttons and File Input -->
  <input type="file" id="imageUpload" accept="image/*" style="display:none;">
  <button id="uploadBtn">Upload Image</button>
  <button id="cameraBtn">Click Picture</button>

  <!-- Video and Canvas Elements -->
  <video id="video" autoplay playsinline style="display:none;"></video>
  <canvas id="canvas" width="640" height="480"></canvas>
  <button id="captureBtn" style="display:none;">Capture</button>
  <p id="result">Dots Counted: 0</p>

  <script>
    const uploadBtn = document.getElementById("uploadBtn");
    const cameraBtn = document.getElementById("cameraBtn");
    const imageUpload = document.getElementById("imageUpload");
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const captureBtn = document.getElementById("captureBtn");
    const ctx = canvas.getContext("2d");
    const resultText = document.getElementById("result");

    // Initialize background subtractor for shadow removal
    const bg = new cv.BackgroundSubtractorMOG2();
    bg.set("nmixtures", 3);
    bg.set("bShadowDetection", true);

    // Event: Upload Image
    uploadBtn.addEventListener("click", () => imageUpload.click());

    imageUpload.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            processImage();
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    // Event: Open Camera
    cameraBtn.addEventListener("click", () => {
      navigator.mediaDevices
        .getUserMedia({ video: { facingMode: "environment" } })
        .then((stream) => {
          video.srcObject = stream;
          video.style.display = "block";
          captureBtn.style.display = "block";
          canvas.style.display = "none";
        })
        .catch((err) => console.error("Camera access error:", err));
    });

    // Event: Capture Image from Camera
    captureBtn.addEventListener("click", () => {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      processImage(); // Process the captured image
      video.style.display = "none";
      captureBtn.style.display = "none";
      canvas.style.display = "block";
    });

    // Process Image and Count Dots
    function processImage() {
      const src = cv.imread(canvas);

      // Convert to Grayscale
      const gray = new cv.Mat();
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

      // Apply Background Subtraction (Shadow Removal)
      const fore = new cv.Mat();
      bg.apply(gray, fore);

      // Erode and Dilate to remove noise and fill small gaps
      cv.erode(fore, fore, new cv.Mat());
      cv.dilate(fore, fore, new cv.Mat());

      // Threshold the image to get a binary image
      const binary = new cv.Mat();
      cv.threshold(fore, binary, 127, 255, cv.THRESH_BINARY);

      // Find contours
      const contours = new cv.MatVector();
      const hierarchy = new cv.Mat();
      cv.findContours(binary, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

      // Draw contours on the frame
      cv.drawContours(src, contours, -1, new cv.Scalar(0, 0, 255), 2);

      // Count the number of contours (dots)
      const dotCount = contours.size();
      resultText.innerText = `Dots Counted: ${dotCount}`;

      // Debug: Display the final image on canvas
      cv.imshow(canvas, src);

      // Clean up memory
      src.delete();
      gray.delete();
      fore.delete();
      binary.delete();
      contours.delete();
      hierarchy.delete();
    }
  </script>
</body>
</html>
